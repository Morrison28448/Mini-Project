{% extends 'base.html' %}
{% block content %}
<div class="page-header">
	<div class="d-flex justify-content-between align-items-center">
		<div>
			<h3>
				<i class="bi bi-person-circle me-2 text-primary"></i>{{ intern.name }} - Details
			</h3>
			<p class="text-muted mb-0">{{ intern.email }} â€¢ {{ intern.department }}</p>
		</div>
		<div class="d-flex gap-2">
			<a href="{% url 'staff_dashboard' %}" class="btn btn-outline-secondary">
				<i class="bi bi-arrow-left me-1"></i>Back to Dashboard
			</a>
			<button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#resetPasswordModal">
				<i class="bi bi-key me-1"></i>Reset Password
			</button>
		</div>
	</div>
</div>

<div class="row g-4 mb-4">
	<div class="col-md-3">
		<div class="card text-center">
			<div class="card-body">
				<h2 class="text-primary mb-0">{{ total_tasks }}</h2>
				<p class="text-muted mb-0">Total Tasks</p>
			</div>
		</div>
	</div>
	<div class="col-md-3">
		<div class="card text-center">
			<div class="card-body">
				<h2 class="text-warning mb-0">{{ pending }}</h2>
				<p class="text-muted mb-0">Pending</p>
			</div>
		</div>
	</div>
	<div class="col-md-3">
		<div class="card text-center">
			<div class="card-body">
				<h2 class="text-success mb-0">{{ resolved }}</h2>
				<p class="text-muted mb-0">Resolved</p>
			</div>
		</div>
	</div>
	<div class="col-md-3">
		<div class="card text-center">
			<div class="card-body">
				<h2 class="text-info mb-0">
					{% if total_tasks > 0 %}
						{% widthratio resolved total_tasks 100 %}%
					{% else %}
						0%
					{% endif %}
				</h2>
				<p class="text-muted mb-0">Completion Rate</p>
			</div>
		</div>
	</div>
</div>

{% if chart_labels %}
<div class="card mb-4">
	<div class="card-header">
		<i class="bi bi-bar-chart-line me-2"></i>Activity Timeline
	</div>
	<div class="card-body">
		<canvas id="activityChart" height="80"></canvas>
	</div>
</div>
{% endif %}

<div class="card">
	<div class="card-header">
		<i class="bi bi-list-ul me-2"></i>All Tasks
	</div>
	<div class="card-body p-0">
		<div class="table-responsive">
			<table class="table table-hover mb-0">
				<thead>
					<tr>
						<th><i class="bi bi-calendar3 me-1"></i>Date</th>
						<th><i class="bi bi-clock me-1"></i>Submitted</th>
						<th><i class="bi bi-list-task me-1"></i>Task</th>
						<th><i class="bi bi-person me-1"></i>Staff</th>
						<th><i class="bi bi-flag me-1"></i>Status</th>
						<th><i class="bi bi-chat-left-text me-1"></i>Remarks</th>
					</tr>
				</thead>
				<tbody>
					{% for task in tasks %}
					<tr>
						<td><strong>{{ task.date }}</strong></td>
						<td>{{ task.created_at|date:"Y-m-d H:i" }}</td>
						<td style="white-space: pre-wrap; max-width: 300px;">{{ task.task_description|truncatewords:20 }}</td>
						<td>{% if task.staff_name %}{{ task.staff_name }}{% elif task.staff %}{{ task.staff.name }}{% else %}-{% endif %}</td>
						<td>
							<span class="badge {% if task.status == 'Resolved' %}bg-success{% else %}bg-warning text-dark{% endif %}">
								<i class="bi bi-{% if task.status == 'Resolved' %}check-circle{% else %}clock{% endif %} me-1"></i>{{ task.status }}
							</span>
						</td>
						<td style="white-space: pre-wrap; max-width: 200px;">{{ task.remarks|default:"-"|truncatewords:10 }}</td>
					</tr>
					{% empty %}
					<tr>
						<td colspan="6" class="empty-state">
							<i class="bi bi-inbox"></i>
							<p class="mb-0">No tasks recorded yet.</p>
						</td>
					</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>
	</div>
</div>

{% if chart_labels %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
const labels = {{ chart_labels|safe }};
const dataPoints = {{ chart_data|safe }};
const ctx = document.getElementById('activityChart').getContext('2d');
const gradient = ctx.createLinearGradient(0, 0, 0, 400);
gradient.addColorStop(0, 'rgba(102, 126, 234, 0.5)');
gradient.addColorStop(1, 'rgba(118, 75, 162, 0.1)');

new Chart(ctx, {
	type: 'bar',
	data: {
		labels: labels,
		datasets: [{
			label: 'Tasks Submitted',
			data: dataPoints,
			fill: true,
			backgroundColor: gradient,
			borderColor: '#667eea',
			borderWidth: 2
		}]
	},
	options: {
		responsive: true,
		scales: {
			y: { beginAtZero: true, ticks: { precision: 0 } }
		}
	}
});
</script>
{% endif %}

<!-- Password Reset Modal -->
<div class="modal fade" id="resetPasswordModal" tabindex="-1" aria-labelledby="resetPasswordModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="resetPasswordModalLabel">
					<i class="bi bi-key me-2"></i>Reset Password for {{ intern.name }}
				</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<form method="post" action="{% url 'staff_reset_intern_password' intern.id %}">
				{% csrf_token %}
				<div class="modal-body">
					{% if password_form.non_field_errors %}
						<div class="alert alert-danger">
							{{ password_form.non_field_errors }}
						</div>
					{% endif %}
					<div class="mb-3">
						<div class="form-check">
							<input class="form-check-input" type="checkbox" name="auto_generate" id="autoGenerate" onchange="togglePasswordField()" {% if password_form.auto_generate.value %}checked{% endif %}>
							<label class="form-check-label" for="autoGenerate">
								<strong>Auto-generate secure password</strong>
							</label>
							<small class="form-text text-muted d-block">System will generate a 12-character secure password</small>
						</div>
					</div>
					<div class="mb-3" id="customPasswordGroup">
						<label for="id_custom_password" class="form-label fw-semibold">Custom Password</label>
						<input type="password" class="form-control {% if password_form.custom_password.errors %}is-invalid{% endif %}" name="custom_password" id="id_custom_password" placeholder="Enter custom password (min 8 characters)" minlength="8" value="{{ password_form.custom_password.value|default:'' }}">
						{% if password_form.custom_password.errors %}
							<div class="invalid-feedback">{{ password_form.custom_password.errors }}</div>
						{% endif %}
						<small class="form-text text-muted">Enter at least 8 characters. Leave empty if auto-generating.</small>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
					<button type="submit" class="btn btn-warning">
						<i class="bi bi-check-circle me-1"></i>Reset Password
					</button>
				</div>
			</form>
		</div>
	</div>
</div>

<script>
function togglePasswordField() {
	const autoGenerate = document.getElementById('autoGenerate');
	const customPasswordGroup = document.getElementById('customPasswordGroup');
	const customPasswordInput = document.getElementById('id_custom_password');
	
	if (autoGenerate && customPasswordGroup && customPasswordInput) {
		if (autoGenerate.checked) {
			customPasswordGroup.style.display = 'none';
			customPasswordInput.value = '';
			customPasswordInput.required = false;
		} else {
			customPasswordGroup.style.display = 'block';
			customPasswordInput.required = true;
		}
	}
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
	togglePasswordField();
	
	// Show modal if needed
	{% if show_password_modal or password_form.errors %}
	const modal = new bootstrap.Modal(document.getElementById('resetPasswordModal'));
	modal.show();
	{% endif %}
	
	// Re-initialize when modal is shown
	const modalElement = document.getElementById('resetPasswordModal');
	if (modalElement) {
		modalElement.addEventListener('shown.bs.modal', function() {
			togglePasswordField();
		});
	}
});
</script>
{% endblock %}

